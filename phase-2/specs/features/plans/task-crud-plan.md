# Implementation Plan: Task CRUD Operations

**Branch**: `main` | **Date**: 2025-12-31 | **Spec**: [task-crud.md](../task-crud.md)
**Input**: Feature specification from `specs/features/task-crud.md`

## Summary

Implement complete CRUD (Create, Read, Update, Delete) operations for user tasks with strict user data isolation. This feature builds on the JWT authentication system (F001) to enable authenticated users to manage their personal tasks through both REST API endpoints and Next.js UI. Every operation enforces user-level security by extracting user_id from JWT tokens and filtering all database queries accordingly.

**Primary Technical Approach**:
- Backend: FastAPI endpoints with SQLModel ORM, JWT dependency injection for auth
- Frontend: Next.js App Router pages with React hooks, API client with auto JWT injection
- Database: PostgreSQL Task model with foreign key to Users, indexed on (user_id, created_at)
- Security: User isolation enforced at query level (404 for cross-user access, not 403)

## Technical Context

**Language/Version**: Python 3.11+ (backend), TypeScript 5.x (frontend)
**Primary Dependencies**:
- Backend: FastAPI 0.109+, SQLModel 0.0.14+, python-jose, pydantic 2.5+
- Frontend: Next.js 16+, React 19+, Better Auth, TailwindCSS 4+

**Storage**: Neon Serverless PostgreSQL (production), SQLite in-memory (tests)
**Testing**: pytest + httpx (backend), Next.js test utilities (frontend)
**Target Platform**:
- Backend: Linux server (containerized FastAPI)
- Frontend: Vercel Edge Runtime (Next.js App Router)

**Project Type**: Web application (separate backend/frontend)
**Performance Goals**:
- API response time <200ms p95 (excluding network)
- Database queries: single query per operation (no N+1)
- UI interactions: <100ms response time for optimistic updates

**Constraints**:
- User data isolation MUST be enforced (Constitution III - NON-NEGOTIABLE)
- All endpoints require JWT authentication except auth endpoints
- Return 404 (not 403) for cross-user access attempts to prevent enumeration
- Task title max 200 chars, description max 2000 chars
- Status must be one of: pending, in_progress, completed

**Scale/Scope**:
- Expected: 100-1000 users, 10-100 tasks per user
- Database: < 1M tasks total (no pagination in MVP)
- API endpoints: 5 CRUD operations + 2 auth (already implemented)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Spec-First Development ✅
- **Status**: PASS
- **Evidence**: Complete specification exists at `specs/features/task-crud.md` with all functional requirements (FR1-FR6), acceptance criteria, and test scenarios
- **Action**: Proceed with implementation only after this plan is complete

### II. JWT Authentication Mandatory ✅
- **Status**: PASS
- **Evidence**: All 5 task endpoints require JWT authentication, auth dependency already implemented (F001)
- **Implementation**: Use `get_current_user_id()` dependency from `backend/app/auth/dependencies.py`

### III. User Data Isolation (NON-NEGOTIABLE) ✅
- **Status**: PASS
- **Evidence**:
  - All database queries filter by `user_id` extracted from JWT
  - Spec explicitly requires user isolation tests for every CRUD operation
  - Cross-user access returns 404 (not 403) per Constitution
- **Implementation**:
  ```python
  # Pattern for all task queries
  task = session.exec(
      select(Task).where(Task.id == task_id, Task.user_id == user_id)
  ).first()
  ```

### IV. API-First Architecture ✅
- **Status**: PASS
- **Evidence**:
  - API contracts defined in `specs/api/rest-endpoints.md`
  - OpenAPI schemas will be auto-generated by FastAPI
  - Frontend will consume documented endpoints only
- **Contract**: See Phase 1 contracts/ directory

### V. Type Safety ✅
- **Status**: PASS
- **Evidence**:
  - Backend: SQLModel Task model, Pydantic schemas for validation
  - Frontend: TypeScript interfaces matching backend schemas
  - Enum for TaskStatus (pending, in_progress, completed)
- **Action**: Ensure no `any` types in TypeScript, all Pydantic models validated

### VI. Test Coverage ✅
- **Status**: PASS
- **Evidence**:
  - Spec defines 9 test scenarios (TS1-TS9)
  - User isolation MUST be tested with multi-user scenarios (TS3, TS4, TS6, TS8)
  - Unit tests for business logic, integration tests for API
- **Target**: >80% coverage for task CRUD operations

### Re-evaluation After Phase 1
*Will be updated after design phase completes*

## Project Structure

### Documentation (this feature)

```text
specs/features/
├── task-crud.md              # Feature specification
├── plans/
│   ├── task-crud-plan.md     # This file (/sp.plan output)
│   ├── research.md           # Phase 0 output (research findings)
│   ├── data-model.md         # Phase 1 output (database models)
│   ├── quickstart.md         # Phase 1 output (implementation guide)
│   └── contracts/            # Phase 1 output (API schemas)
│       ├── task-create.json  # POST /api/tasks contract
│       ├── task-list.json    # GET /api/tasks contract
│       ├── task-get.json     # GET /api/tasks/{id} contract
│       ├── task-update.json  # PUT /api/tasks/{id} contract
│       └── task-delete.json  # DELETE /api/tasks/{id} contract
└── tasks/
    └── task-crud-tasks.md    # Phase 2 output (/sp.tasks - NOT created by /sp.plan)
```

### Source Code (repository root)

```text
backend/
├── app/
│   ├── models/
│   │   ├── __init__.py
│   │   ├── user.py           # Already exists (F001)
│   │   └── task.py           # NEW: Task SQLModel with status enum
│   ├── schemas/
│   │   ├── __init__.py
│   │   ├── auth.py           # Already exists (F001)
│   │   └── task.py           # NEW: Pydantic request/response schemas
│   ├── api/
│   │   └── v1/
│   │       ├── __init__.py
│   │       ├── auth.py       # Already exists (F001)
│   │       └── tasks.py      # NEW: 5 CRUD endpoints
│   ├── auth/
│   │   ├── dependencies.py   # Already exists (get_current_user_id)
│   │   └── ...               # Other auth files from F001
│   ├── db/
│   │   └── session.py        # Already exists (F001)
│   └── main.py               # Update: include tasks router
└── tests/
    ├── conftest.py           # Already exists (F001)
    ├── test_auth.py          # Already exists (F001)
    └── test_tasks.py         # NEW: Task CRUD tests + user isolation

frontend/
├── app/
│   ├── dashboard/
│   │   ├── layout.tsx        # Already exists (F001)
│   │   └── page.tsx          # UPDATE: Replace placeholder with task list
│   ├── tasks/
│   │   ├── new/
│   │   │   └── page.tsx      # NEW: Create task form
│   │   └── [id]/
│   │       └── page.tsx      # NEW: Edit task form
│   └── ... # Other pages from F001
├── components/
│   ├── tasks/
│   │   ├── TaskList.tsx      # NEW: Task list display
│   │   ├── TaskCard.tsx      # NEW: Single task card
│   │   ├── TaskForm.tsx      # NEW: Create/edit form
│   │   └── StatusBadge.tsx   # NEW: Status visual indicator
│   └── ... # Other components
├── lib/
│   ├── api.ts                # Already exists (auto JWT injection)
│   └── task-api.ts           # NEW: Task-specific API functions
└── types/
    ├── auth.ts               # Already exists (F001)
    └── task.ts               # NEW: Task interfaces

database/
└── migrations/               # If using Alembic
    └── 002_create_tasks.sql  # NEW: Task table migration
```

**Structure Decision**: Web application (Option 2) selected based on existing backend/ and frontend/ directories from F001. Backend handles API and business logic, frontend provides UI. Both communicate via REST API with JWT tokens.

## Complexity Tracking

*No Constitution violations identified. All gates passed.*

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A | N/A | N/A |

## Phase 0: Research & Decisions

See `research.md` for detailed findings. Summary:

### Decision 1: TaskStatus Enum Implementation
- **Chosen**: Python Enum (str, Enum) + TypeScript union type
- **Rationale**: Type-safe, auto-validation, consistent across stack
- **Alternatives**: Plain strings (rejected - no validation), integer flags (rejected - not readable)

### Decision 2: User Isolation Pattern
- **Chosen**: Explicit WHERE clause with user_id in every query
- **Rationale**: Visible, auditable, no magic, Constitution III compliance
- **Alternatives**: Row-Level Security (rejected - Neon limitations), Middleware filtering (rejected - implicit)

### Decision 3: Error Response for Cross-User Access
- **Chosen**: 404 Not Found (not 403 Forbidden)
- **Rationale**: Prevents user enumeration, doesn't leak existence of other users' data
- **Alternatives**: 403 (rejected - reveals task exists), 401 (rejected - misleading)

### Decision 4: Task List Ordering
- **Chosen**: created_at DESC (newest first)
- **Rationale**: Most recent tasks are most relevant, matches user expectation
- **Alternatives**: alphabetical (rejected - less useful), status-based (rejected - adds complexity)

### Decision 5: Frontend State Management
- **Chosen**: React useState + API client (no global state)
- **Rationale**: Simple, sufficient for MVP scope, avoids complexity
- **Alternatives**: Redux (rejected - overkill), Zustand (rejected - unnecessary for task list)

## Phase 1: Design & Contracts

See detailed artifacts:
- `data-model.md`: Task SQLModel definition, relationships, constraints
- `contracts/`: OpenAPI schemas for all 5 endpoints
- `quickstart.md`: Step-by-step implementation guide

### Key Design Decisions

**Database Schema**:
- Task model with foreign key to User
- Composite index on (user_id, created_at DESC) for fast list queries
- Cascade delete when user deleted

**API Contracts**:
- POST /api/tasks: Create task (auto-assign user_id from JWT)
- GET /api/tasks: List user's tasks (filtered by JWT user_id)
- GET /api/tasks/{task_id}: Get single task (404 if not owned)
- PUT /api/tasks/{task_id}: Update task (partial updates, 404 if not owned)
- DELETE /api/tasks/{task_id}: Delete task (204 on success, 404 if not owned)

**Frontend Flow**:
1. Dashboard displays task list (GET /api/tasks)
2. "New Task" button → /tasks/new form
3. Create form submits → POST /api/tasks → redirect to dashboard
4. Task card click → /tasks/[id] edit form
5. Edit form → PUT /api/tasks/{id} → redirect to dashboard
6. Delete button → confirm → DELETE /api/tasks/{id} → refresh list

## Implementation Sequence

*This is filled in Phase 2 by /sp.tasks command*

Will be broken down into atomic tasks covering:
1. Backend Task model and database migration
2. Backend Pydantic schemas for validation
3. Backend CRUD endpoints with user isolation
4. Backend tests (unit + integration + user isolation)
5. Frontend TypeScript types
6. Frontend API client functions
7. Frontend TaskList component
8. Frontend Create/Edit forms
9. Frontend integration with dashboard
10. End-to-end testing

## Success Criteria

Feature is DONE when:
- [ ] All 5 CRUD endpoints implemented and tested
- [ ] User isolation verified with multi-user tests (TS3, TS4, TS6, TS8)
- [ ] All validation rules enforced (title length, description length, status values)
- [ ] All error cases return correct status codes (401, 404, 422)
- [ ] UI allows creating, viewing, updating, and deleting tasks
- [ ] API documentation (OpenAPI) auto-generated and accurate
- [ ] Integration tests pass with >80% coverage
- [ ] Manual testing completed for all user flows
- [ ] No cross-user data leakage (verified by isolation tests)

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|-----------|
| User isolation bug (cross-user access) | Medium | CRITICAL | Mandatory multi-user isolation tests, code review focus on WHERE clauses |
| N+1 query performance issue | Low | Medium | Use single queries, add composite index on (user_id, created_at) |
| Frontend state synchronization | Low | Low | Refresh from API after mutations, optimistic updates not required for MVP |
| Validation inconsistency (frontend vs backend) | Medium | Low | Share TypeScript types, backend always authoritative |

## Dependencies

**Depends On**:
- ✅ F001 (Authentication): JWT auth implemented, `get_current_user_id()` dependency available
- ✅ Database: Users table exists, PostgreSQL connection configured
- ✅ Frontend: Next.js project initialized, API client with JWT injection ready

**Blocks**:
- None (Task CRUD is final feature for MVP)

## Next Steps

1. **Phase 0 Complete**: Research.md created with all decisions documented
2. **Phase 1 Next**: Generate data-model.md, contracts/, and quickstart.md
3. **After Plan Approval**: Run `/sp.tasks` to break down into atomic implementation tasks
4. **Implementation**: Execute tasks following quickstart guide
5. **Testing**: Verify user isolation, run integration tests, manual QA
6. **ADR**: Document significant architecture decisions if any emerge during implementation

---

**Plan Status**: Complete - Ready for Phase 1 artifact generation
**Author**: Claude Sonnet 4.5
**Date**: 2025-12-31
